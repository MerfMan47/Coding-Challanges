Cleaned up the code, added comments, and optimised code